<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Change Tracking ‚Äî ToolIntel Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0f2744;
            --blue-accent: #3b82f6;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-400: #9ca3af;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --white: #ffffff;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--gray-50); color: var(--gray-800); }
        
        header { background: var(--navy); color: white; padding: 20px 24px; }
        header h1 { font-size: 1.5rem; font-weight: 600; }
        header .subtitle { color: var(--gray-400); font-size: 0.9rem; margin-top: 4px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; border: none; background: var(--white); border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 500; color: var(--gray-600); border: 1px solid var(--gray-200); }
        .tab.active { background: var(--navy); color: white; border-color: var(--navy); }
        .tab .badge { background: var(--red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px; }
        
        .panel { display: none; }
        .panel.active { display: block; }
        
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--white); border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px; text-align: center; }
        .stat-card .number { font-size: 2rem; font-weight: 700; color: var(--navy); }
        .stat-card .label { font-size: 0.85rem; color: var(--gray-600); }
        .stat-card.alert .number { color: var(--red); }
        
        .card { background: var(--white); border: 1px solid var(--gray-200); border-radius: 8px; padding: 20px; margin-bottom: 16px; }
        .card.pending { border-left: 4px solid var(--yellow); background: #fffbeb; }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-title { font-weight: 600; color: var(--navy); }
        
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
        .status-badge.green { background: #d1fae5; color: #065f46; }
        .status-badge.yellow { background: #fef3c7; color: #92400e; }
        .status-badge.red { background: #fee2e2; color: #991b1b; }
        
        .impact-badge { padding: 3px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .impact-badge.low { background: #d1fae5; color: #065f46; }
        .impact-badge.medium { background: #fef3c7; color: #92400e; }
        .impact-badge.high { background: #fee2e2; color: #991b1b; }
        
        .policy-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 0.9rem; }
        .policy-table th, .policy-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200); }
        .policy-table th { background: var(--gray-50); font-weight: 600; color: var(--navy); font-size: 0.85rem; }
        .policy-table tr:hover { background: var(--gray-50); }
        .policy-table a { color: var(--blue-accent); text-decoration: none; }
        
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-primary { background: var(--navy); color: white; }
        .btn-success { background: var(--green); color: white; }
        .btn-secondary { background: var(--gray-100); color: var(--gray-600); border: 1px solid var(--gray-200); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 8px; margin-top: 12px; }
        
        .detail-row { display: flex; gap: 24px; margin-bottom: 8px; font-size: 0.9rem; }
        .detail-label { color: var(--gray-400); min-width: 140px; }
        .detail-value { color: var(--gray-800); }
        .detail-value a { color: var(--blue-accent); text-decoration: none; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.9rem; font-weight: 500; color: var(--gray-600); margin-bottom: 6px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.95rem; }
        .form-group textarea { min-height: 80px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        .empty-state { text-align: center; padding: 60px 24px; color: var(--gray-400); }
        
        .alert-banner { background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 12px 16px; border-radius: 8px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        
        .data-rights-form { background: var(--gray-50); padding: 16px; border-radius: 8px; margin-top: 20px; }
        .data-rights-form h4 { margin-bottom: 16px; color: var(--navy); }
        .data-rights-row { display: grid; grid-template-columns: 1fr 1fr 150px; gap: 12px; margin-bottom: 12px; align-items: end; }
        .data-rights-row label { font-size: 0.85rem; color: var(--gray-600); margin-bottom: 4px; display: block; }
        
        .commitment-note { font-size: 0.8rem; color: var(--gray-400); padding: 12px; background: var(--gray-50); border-radius: 6px; margin-top: 24px; text-align: center; }
        
        @media (max-width: 768px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .form-row, .data-rights-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üìã Policy Change Tracking</h1>
        <div class="subtitle">Terms of Service & Privacy Policy Monitoring</div>
    </header>
    
    <div class="container">
        <div id="alertBanner" class="alert-banner" style="display:none;">
            <span>‚ö†Ô∏è</span>
            <span id="alertText">Policy changes detected - review required</span>
        </div>
        
        <div class="stats-row">
            <div class="stat-card"><div class="number" id="statToolsTracked">-</div><div class="label">Tools Tracked</div></div>
            <div class="stat-card"><div class="number" id="statTotalChanges">-</div><div class="label">Total Changes</div></div>
            <div class="stat-card alert"><div class="number" id="statPendingReview">-</div><div class="label">Pending Review</div></div>
            <div class="stat-card"><div class="number" id="statMonitors">-</div><div class="label">URLs Monitored</div></div>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-panel="queue">‚è∞ Review Queue <span class="badge" id="queueBadge" style="display:none;">0</span></button>
            <button class="tab" data-panel="changes">üìã All Changes</button>
            <button class="tab" data-panel="monitors">üîç URL Monitors</button>
            <button class="tab" data-panel="add">‚ûï Add Change</button>
        </div>
        
        <!-- Review Queue Panel -->
        <div class="panel active" id="panel-queue">
            <p style="color: var(--gray-600); margin-bottom: 16px;">Policy pages where changes were detected. Review, summarize in plain English, and assign buyer impact.</p>
            <div id="queueList">
                <div class="empty-state">Loading...</div>
            </div>
        </div>
        
        <!-- All Changes Panel -->
        <div class="panel" id="panel-changes">
            <div id="changesList">
                <div class="empty-state">Loading...</div>
            </div>
        </div>
        
        <!-- Monitors Panel -->
        <div class="panel" id="panel-monitors">
            <div class="card">
                <h3 style="margin-bottom: 16px;">Add URL to Monitor</h3>
                <form id="monitorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tool Slug</label>
                            <input type="text" name="toolSlug" required placeholder="chatgpt">
                        </div>
                        <div class="form-group">
                            <label>Tool Name</label>
                            <input type="text" name="toolName" placeholder="ChatGPT">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Document Type</label>
                            <select name="documentType" required>
                                <option value="">Select...</option>
                                <option value="Terms of Service">Terms of Service</option>
                                <option value="Privacy Policy">Privacy Policy</option>
                                <option value="Data Processing Agreement">Data Processing Agreement</option>
                                <option value="Acceptable Use Policy">Acceptable Use Policy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>URL to Monitor</label>
                            <input type="url" name="url" required placeholder="https://openai.com/policies/terms-of-use">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Monitor</button>
                </form>
            </div>
            
            <h3 style="margin: 24px 0 16px;">Active Monitors</h3>
            <div id="monitorsList">
                <div class="empty-state">Loading...</div>
            </div>
            
            <div style="margin-top: 24px;">
                <button class="btn btn-secondary" onclick="checkAllMonitors()">üîÑ Check All Monitors Now</button>
            </div>
        </div>
        
        <!-- Add Change Panel -->
        <div class="panel" id="panel-add">
            <div class="card">
                <h3 style="margin-bottom: 16px;">Add Policy Change Record</h3>
                <form id="changeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tool Slug *</label>
                            <input type="text" name="toolSlug" required placeholder="chatgpt">
                        </div>
                        <div class="form-group">
                            <label>Tool Name</label>
                            <input type="text" name="toolName" placeholder="ChatGPT">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Change *</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label>Document Changed *</label>
                            <select name="documentType" required>
                                <option value="">Select...</option>
                                <option value="Terms of Service">Terms of Service</option>
                                <option value="Privacy Policy">Privacy Policy</option>
                                <option value="Data Processing Agreement">Data Processing Agreement</option>
                                <option value="Acceptable Use Policy">Acceptable Use Policy</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>What Changed (plain English, one sentence max) *</label>
                        <input type="text" name="whatChanged" required placeholder="Added clause allowing use of API inputs for model training" maxlength="200">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Buyer Impact *</label>
                            <select name="buyerImpact" required>
                                <option value="">Select...</option>
                                <option value="Low">Low ‚Äî Cosmetic or clarifying changes</option>
                                <option value="Medium">Medium ‚Äî New restrictions or obligations</option>
                                <option value="High">High ‚Äî Data rights, training, or liability changes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Source Link</label>
                            <input type="url" name="sourceLink" placeholder="https://...">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Change Record</button>
                </form>
                
                <div class="data-rights-form">
                    <h4>Update Data Rights Tracking</h4>
                    <form id="dataRightsForm">
                        <div class="form-group">
                            <label>Tool Slug *</label>
                            <input type="text" name="toolSlug" required placeholder="chatgpt" style="max-width: 300px;">
                        </div>
                        <div class="data-rights-row">
                            <div>
                                <label>Training Data Usage</label>
                                <input type="text" name="trainingStatus" placeholder="e.g., Opt-out available for API">
                            </div>
                            <div>
                                <label>Last Changed</label>
                                <input type="date" name="trainingDate">
                            </div>
                        </div>
                        <div class="data-rights-row">
                            <div>
                                <label>IP Rights (inputs/outputs)</label>
                                <input type="text" name="ipStatus" placeholder="e.g., User retains all rights">
                            </div>
                            <div>
                                <label>Last Changed</label>
                                <input type="date" name="ipDate">
                            </div>
                        </div>
                        <div class="data-rights-row">
                            <div>
                                <label>Arbitration Clause</label>
                                <input type="text" name="arbitrationStatus" placeholder="e.g., Mandatory, opt-out within 30 days">
                            </div>
                            <div>
                                <label>Last Changed</label>
                                <input type="date" name="arbitrationDate">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-secondary" style="margin-top: 12px;">Update Data Rights</button>
                    </form>
                </div>
            </div>
            
            <div class="commitment-note">
                ‚ö†Ô∏è Policy change records are permanent. ToolIntel does not remove or alter historical policy records at vendor request.
            </div>
        </div>
    </div>

    <script>
    const API = 'https://v7086lxsji.execute-api.us-east-1.amazonaws.com';
    const KEY = new URLSearchParams(window.location.search).get('key') || '';
    
    if (!KEY) {
        document.body.innerHTML = '<div style="padding:60px;text-align:center;color:#991b1b;">Admin key required. Add ?key=YOUR_KEY to URL.</div>';
    }
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`panel-${tab.dataset.panel}`).classList.add('active');
        });
    });
    
    function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function formatDate(d) { return new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }); }
    
    async function loadQueue() {
        try {
            const r = await fetch(`${API}/policies/admin/queue?key=${KEY}`);
            const items = await r.json();
            const container = document.getElementById('queueList');
            
            document.getElementById('statPendingReview').textContent = items.length;
            const queueBadge = document.getElementById('queueBadge');
            if (items.length > 0) {
                queueBadge.textContent = items.length;
                queueBadge.style.display = 'inline';
                document.getElementById('alertBanner').style.display = 'flex';
            } else {
                queueBadge.style.display = 'none';
                document.getElementById('alertBanner').style.display = 'none';
            }
            
            if (!items.length) {
                container.innerHTML = '<div class="empty-state">‚úÖ No pending policy changes. All caught up!</div>';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="card pending" id="queue-${esc(item.monitorId)}">
                    <div class="card-header">
                        <span class="card-title">${esc(item.toolName || item.toolSlug)} ‚Äî ${esc(item.documentType)}</span>
                        <span style="font-size: 0.85rem; color: var(--gray-400);">Detected: ${item.changeDetectedAt ? formatDate(item.changeDetectedAt) : 'Unknown'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">URL:</span>
                        <span class="detail-value"><a href="${esc(item.url)}" target="_blank">${esc(item.url)}</a></span>
                    </div>
                    <p style="margin: 12px 0; color: var(--gray-600); font-size: 0.9rem;">
                        Review the change, then add a Change Record with a plain English summary and buyer impact rating.
                    </p>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="resolveChange('${esc(item.monitorId)}')">‚úì Mark Reviewed</button>
                        <a href="${esc(item.url)}" target="_blank" class="btn btn-secondary btn-sm">Open URL</a>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error(e);
        }
    }
    
    async function loadChanges() {
        try {
            const r = await fetch(`${API}/policies/admin/all?key=${KEY}`);
            const tools = await r.json();
            const container = document.getElementById('changesList');
            
            const totalTools = tools.filter(t => t.changeCount > 0).length;
            const totalChanges = tools.reduce((sum, t) => sum + t.changeCount, 0);
            
            document.getElementById('statToolsTracked').textContent = totalTools;
            document.getElementById('statTotalChanges').textContent = totalChanges;
            
            if (!tools.length || totalChanges === 0) {
                container.innerHTML = '<div class="empty-state">No policy changes recorded yet.</div>';
                return;
            }
            
            container.innerHTML = tools.filter(t => t.changeCount > 0).map(tool => `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">${esc(tool.toolSlug)}</span>
                        <span class="status-badge ${tool.statusBadge?.color || 'green'}">${esc(tool.statusBadge?.text || '')}</span>
                    </div>
                    <table class="policy-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Document</th>
                                <th>What Changed</th>
                                <th>Impact</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tool.changes.sort((a,b) => new Date(b.date) - new Date(a.date)).map(c => `
                                <tr>
                                    <td>${formatDate(c.date)}</td>
                                    <td>${esc(c.documentType)}</td>
                                    <td>${esc(c.whatChanged)}</td>
                                    <td><span class="impact-badge ${(c.buyerImpact || '').toLowerCase()}">${esc(c.buyerImpact)}</span></td>
                                    <td>${c.sourceLink ? `<a href="${esc(c.sourceLink)}" target="_blank">${esc(c.sourceName || 'Source')}</a>` : esc(c.sourceName || '-')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `).join('');
        } catch (e) {
            console.error(e);
        }
    }
    
    async function loadMonitors() {
        try {
            const r = await fetch(`${API}/policies/admin/monitors?key=${KEY}`);
            const items = await r.json();
            const container = document.getElementById('monitorsList');
            
            document.getElementById('statMonitors').textContent = items.length;
            
            if (!items.length) {
                container.innerHTML = '<div class="empty-state">No URLs being monitored. Add some above.</div>';
                return;
            }
            
            container.innerHTML = `
                <table class="policy-table">
                    <thead>
                        <tr>
                            <th>Tool</th>
                            <th>Document</th>
                            <th>URL</th>
                            <th>Last Checked</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(m => `
                            <tr>
                                <td>${esc(m.toolName || m.toolSlug)}</td>
                                <td>${esc(m.documentType)}</td>
                                <td><a href="${esc(m.url)}" target="_blank">${esc(m.url.substring(0, 50))}...</a></td>
                                <td>${m.lastChecked ? formatDate(m.lastChecked) : 'Never'}</td>
                                <td>${m.changeDetected ? '<span class="status-badge yellow">Change Detected</span>' : '<span class="status-badge green">No Change</span>'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (e) {
            console.error(e);
        }
    }
    
    async function resolveChange(monitorId) {
        try {
            const r = await fetch(`${API}/policies/admin/resolve-change`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: KEY, monitorId })
            });
            if (r.ok) {
                document.getElementById(`queue-${monitorId}`)?.remove();
                loadQueue();
                alert('Change marked as reviewed');
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }
    
    async function checkAllMonitors() {
        if (!confirm('Check all monitored URLs for changes? This may take a moment.')) return;
        try {
            const r = await fetch(`${API}/policies/admin/check-monitors`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: KEY })
            });
            const result = await r.json();
            alert(`Checked ${result.results?.length || 0} monitors. ${result.changesDetected || 0} changes detected.`);
            loadQueue();
            loadMonitors();
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }
    
    document.getElementById('monitorForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = new FormData(this);
        try {
            const r = await fetch(`${API}/policies/admin/add-monitor`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    key: KEY,
                    toolSlug: form.get('toolSlug'),
                    toolName: form.get('toolName'),
                    documentType: form.get('documentType'),
                    url: form.get('url')
                })
            });
            if (r.ok) {
                alert('Monitor added');
                this.reset();
                loadMonitors();
            } else {
                const err = await r.json();
                alert('Error: ' + (err.error || 'Unknown'));
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });
    
    document.getElementById('changeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = new FormData(this);
        try {
            const r = await fetch(`${API}/policies/admin/add-change`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    key: KEY,
                    toolSlug: form.get('toolSlug'),
                    toolName: form.get('toolName'),
                    date: form.get('date'),
                    documentType: form.get('documentType'),
                    whatChanged: form.get('whatChanged'),
                    buyerImpact: form.get('buyerImpact'),
                    sourceLink: form.get('sourceLink')
                })
            });
            if (r.ok) {
                alert('Change record added');
                this.reset();
                loadChanges();
            } else {
                const err = await r.json();
                alert('Error: ' + (err.error || 'Unknown'));
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });
    
    document.getElementById('dataRightsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = new FormData(this);
        try {
            const r = await fetch(`${API}/policies/admin/update-data-rights`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    key: KEY,
                    toolSlug: form.get('toolSlug'),
                    trainingData: form.get('trainingStatus') ? { status: form.get('trainingStatus'), lastChanged: form.get('trainingDate') || null } : null,
                    ipRights: form.get('ipStatus') ? { status: form.get('ipStatus'), lastChanged: form.get('ipDate') || null } : null,
                    arbitration: form.get('arbitrationStatus') ? { status: form.get('arbitrationStatus'), lastChanged: form.get('arbitrationDate') || null } : null
                })
            });
            if (r.ok) {
                alert('Data rights updated');
                this.reset();
            } else {
                const err = await r.json();
                alert('Error: ' + (err.error || 'Unknown'));
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });
    
    loadQueue();
    loadChanges();
    loadMonitors();
    </script>
</body>
</html>
